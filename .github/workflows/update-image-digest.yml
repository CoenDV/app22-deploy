name: Update Image Digest

on:
    workflow_call:
        inputs:
            service-name:
                required: true
                type: string
                description: "Service name (e.g., VideoService, ChatService)"
            image-name:
                required: true
                type: string
                description: "Full image name without tag (e.g., ghcr.io/inholland-cloud-minor-2526/group1-videoservice)"
            environment:
                required: true
                type: string
                description: "Environment (prod or test)"
            branch:
                required: true
                type: string
                description: "Branch that was built (main or dev)"
        secrets:
            DEPLOY_REPO_TOKEN:
                required: true
                description: "Personal Access Token with access to deployment repo"

jobs:
    update-digest:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout deployment repo
              uses: actions/checkout@v4
              with:
                  repository: CoenDV/simpleSlideshow-deploy
                  token: ${{ secrets.DEPLOY_REPO_TOKEN }}
                  path: deploy-repo

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Get image digest
              id: digest
              run: |
                  docker pull ${{ inputs.image-name }}:${{ inputs.branch }}
                  DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ inputs.image-name }}:${{ inputs.branch }} | cut -d'@' -f2)
                  echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
                  echo "Image digest: ${DIGEST}"

            - name: Update kustomization
              working-directory: deploy-repo/${{ inputs.service-name }}/overlays/${{ inputs.environment }}
              run: |
                  # Read current kustomization
                  NAMESPACE=$(grep "namespace:" kustomization.yaml | awk '{print $2}')

                  # Write new kustomization with digest
                  cat > kustomization.yaml << EOF
                  apiVersion: kustomize.config.k8s.io/v1beta1
                  kind: Kustomization

                  namespace: ${NAMESPACE}

                  resources:
                    - ../../base

                  images:
                    - name: ${{ inputs.image-name }}
                      digest: ${{ steps.digest.outputs.digest }}
                  EOF

                  echo "Updated kustomization.yaml:"
                  cat kustomization.yaml

            - name: Commit and push
              working-directory: deploy-repo
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add ${{ inputs.service-name }}/overlays/${{ inputs.environment }}/kustomization.yaml

                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                  else
                    SHORT_DIGEST=$(echo "${{ steps.digest.outputs.digest }}" | cut -d':' -f2 | cut -c1-12)
                    git commit -m "Update ${{ inputs.service-name }} ${{ inputs.environment }} image digest to ${SHORT_DIGEST}"
                    git push
                  fi
